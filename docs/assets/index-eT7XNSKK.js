(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=o(i);fetch(i.href,n)}})();const q="sense_settings_v1",Q="sense_owned_v1",p={owned:{hand:[],foot:[]},settings:{sound:"spatial",pulse:"normal",light:"off",hand:"none",foot:"none"},runtime:{lastInputAt:performance.now(),idleMs:0}};function W(){try{const e=localStorage.getItem(q);e&&(p.settings={...p.settings,...JSON.parse(e)})}catch{}try{const e=localStorage.getItem(Q);e&&(p.owned={...p.owned,...JSON.parse(e)})}catch{}}function Z(){localStorage.setItem(q,JSON.stringify(p.settings))}function ee(e,t){p.settings[e]=t,Z()}function te(e,t){return(p.owned[e]||[]).includes(t)}function ne(){p.runtime.lastInputAt=performance.now()}function oe(e=performance.now()){return Math.max(0,e-p.runtime.lastInputAt)}const B=[{id:"legal-1",label:"特商法",href:"./legal/transactions.html",icon:"doc"},{id:"legal-2",label:"利用規約",href:"./legal/terms_of_service.html",icon:"link"},{id:"legal-3",label:"プライバシー",href:"./legal/privacy_policy.html",icon:"shield"}],z=7e3,D=18e3,X=5200;function _(e,t){return Math.random()*(t-e)+e}function k(e,t){return Math.floor(_(e,t+1))}function V(e,t,o){return Math.max(t,Math.min(o,e))}function ie(e){const t=window.innerWidth,o=window.innerHeight,s=o*.82,i=o*.94,n=24,r=Math.max(n,t-24),g=_(n+20,r-20),f=_(s,i),l=[];for(let u=0;u<e;u++){const d=_(-80,80)+u*_(34,62),c=_(-18,18);l.push({x:V(g+d,n,r),y:V(f+c,s,i)})}return l}function se(e){return e==="doc"?'<svg viewBox="0 0 24 24"><path d="M6 2h8l4 4v16H6V2zm8 1.5V7h3.5L14 3.5zM8 11h8v1.6H8V11zm0 4h8v1.6H8V15z"/></svg>':e==="shield"?'<svg viewBox="0 0 24 24"><path d="M12 2l8 4v6c0 5.2-3.4 9.9-8 10-4.6-.1-8-4.8-8-10V6l8-4zm0 2.2L6 7v5c0 4.2 2.6 8 6 8 3.4 0 6-3.8 6-8V7l-6-2.8z"/></svg>':'<svg viewBox="0 0 24 24"><path d="M10.6 13.4a1 1 0 0 1 0-1.4l3-3a1 1 0 1 1 1.4 1.4l-3 3a1 1 0 0 1-1.4 0zM7 17a4 4 0 0 1 0-5.7l2-2A4 4 0 0 1 14.7 9a1 1 0 1 1-1.4 1.4 2 2 0 0 0-2.8 0l-2 2A2 2 0 1 0 11.3 15a1 1 0 1 1 1.4 1.4A4 4 0 0 1 7 17zm10-10a4 4 0 0 1 0 5.7l-2 2A4 4 0 0 1 9.3 15a1 1 0 1 1 1.4-1.4 2 2 0 0 0 2.8 0l2-2A2 2 0 1 0 12.7 9a1 1 0 1 1-1.4-1.4A4 4 0 0 1 17 7z"/></svg>'}function re(e){const t=document.createElement("a");return t.className="legal-item",t.href=e.href,t.target="_blank",t.rel="noopener noreferrer",t.dataset.id=e.id,t.innerHTML=`<span class="legal-icon">${se(e.icon)}</span><span class="legal-label">${e.label}</span>`,t}function ae({dockEl:e}){if(!e)return;e.innerHTML="";const t=new Map;for(const d of B){const c=re(d);t.set(d.id,c),e.appendChild(c)}let o=new Set,s=null,i=0;const n=()=>{const d=[...o],c=ie(d.length);d.forEach((m,b)=>{const a=t.get(m);a&&(a.style.left=`${c[b].x}px`,a.style.top=`${c[b].y}px`)})},r=(d,c)=>{const m=t.get(d);m&&m.classList.toggle("is-visible",!!c)},g=d=>{o=new Set(d);for(const c of B)r(c.id,o.has(c.id));n()},f=()=>{s&&clearTimeout(s);const d=()=>{if(Date.now()<i){s=setTimeout(d,900);return}const m=B.map(a=>a.id).filter(a=>!o.has(a));if(m.length===0)return;o.add(m[0]),r(m[0],!0),n(),B.every(a=>o.has(a.id))&&(i=Date.now()+X),s=setTimeout(d,k(z,D))};s=setTimeout(d,k(z,D))},l=()=>{const d=B.map(c=>c.id);g(d),i=Date.now()+X,f()},u=()=>{Date.now()<i||l()};window.addEventListener("pointerdown",u,{passive:!0}),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("wheel",u,{passive:!0}),window.addEventListener("resize",n,{passive:!0}),l()}const F=6,Y=14,P=9e3,$=22e3,C=8;function ce({gearEl:e}){if(!e)return;N(e);const t=()=>{e.style.transition="transform 120ms ease",N(e),setTimeout(()=>e.style.transition="",220),setTimeout(t,R(P,$))};setTimeout(t,R(P,$)),window.addEventListener("resize",()=>N(e),{passive:!0})}function N(e){const t=H(F,Y),o=H(F,Y),s=e.getBoundingClientRect(),i=window.innerWidth,n=window.innerHeight;let r=t,g=o;s.right+t>i-C&&(r=-Math.abs(t)),s.left+t<C&&(r=Math.abs(t)),s.bottom+o>n-C&&(g=-Math.abs(o)),s.top+o<C&&(g=Math.abs(o)),e.style.transform=`translate3d(${r}px, ${g}px, 0)`}function H(e,t){const o=R(e,t);return Math.random()<.5?-o:o}function R(e,t){return Math.floor(Math.random()*(t-e+1))+e}const le=[{key:"sound",label:"sound field",options:["spatial","mono","none"]},{key:"light",label:"light",options:["off","low"]},{key:"pulse",label:"pulse",options:["low","normal","high"]},{key:"hand",label:"bring what you have (hand)",options:["none","stick","light","glove"]},{key:"foot",label:"bring what you have (foot)",options:["none","shoes","leather","heel","zori"]},{key:"__operation__",label:"operation",action:"open_operation"}];function K(){const e=document.getElementById("settingsOverlay"),t=document.getElementById("settingsList"),o=document.getElementById("settingsClose");t.innerHTML="";const s=[...le].map(n=>({v:n,r:Math.random()})).sort((n,r)=>n.r-r.r).map(n=>n.v);for(const n of s){if(n.action==="open_operation"){const l=document.createElement("div");l.className="setting-item";const u=document.createElement("span");u.textContent=n.label;const d=document.createElement("button");d.className="setting-select",d.textContent="view",d.addEventListener("click",()=>{const c=document.getElementById("operationOverlay");c.hidden=!1}),l.appendChild(u),l.appendChild(d),t.appendChild(l);continue}const r=document.createElement("div");r.className="setting-item";const g=document.createElement("span");g.textContent=n.label;const f=document.createElement("select");f.className="setting-select";for(const l of n.options){const u=document.createElement("option");u.value=l,u.textContent=l,p.settings[n.key]===l&&(u.selected=!0),f.appendChild(u)}f.addEventListener("change",l=>{const u=l.target.value;if(n.key==="hand"&&u!=="none"&&!p.owned.hand.includes(u)){alert("You need to purchase this item before using it."),f.value=p.settings[n.key];return}if(n.key==="foot"&&u!=="none"&&!p.owned.foot.includes(u)){alert("You need to purchase this item before using it."),f.value=p.settings[n.key];return}ee(n.key,u),Z()}),r.appendChild(g),r.appendChild(f),t.appendChild(r)}o.onclick=()=>{e.hidden=!0};const i=document.getElementById("operationOverlay");i&&i.addEventListener("pointerdown",()=>{i.hidden=!0}),e.addEventListener("pointerdown",n=>{n.target.closest(".settings-panel")||(e.hidden=!0)})}function ue(){K();const e=document.getElementById("settingsOverlay");e.hidden=!1}function de(){const e=document.getElementById("settingsOverlay");e.hidden=!0}function fe({canvas:e,onAnyInput:t,onRoam:o,onStep:s,onHoldWalk:i,onTouch:n,onPinch:r,onTapSpot:g}){let f=0,l=0,u=0,d=!1,c=!1,m=0,b=!1,a=0;const y=()=>performance.now(),h=v=>{t==null||t();const M=v.touches?[...v.touches]:null;if(M&&M.length===2){b=!0,a=J(M[0],M[1]);return}c=!0,m=O(v),d=!1,clearTimeout(u),u=window.setTimeout(()=>{d=!0,i==null||i(!0)},320)},E=v=>{if(v.touches&&v.touches.length===2){t==null||t(),b=!0;const I=J(v.touches[0],v.touches[1]),j=I-a;a=I,r==null||r(j);return}if(!c)return;t==null||t();const M=O(v),x=M-m;m=M,o==null||o(x)},T=v=>{if(b){(!v.touches||v.touches.length<2)&&(b=!1);return}if(c=!1,clearTimeout(u),d){d=!1,i==null||i(!1);return}const M=y();M-f<320?l+=1:l=1,f=M;const x=O(v),I=me(v);g==null||g(x,I),window.setTimeout(()=>{y()-f>280&&(l===2?s==null||s(1):l>=3?s==null||s(-1):n==null||n(),l=0)},300)};e.addEventListener("touchstart",h,{passive:!0}),e.addEventListener("touchmove",E,{passive:!0}),e.addEventListener("touchend",T,{passive:!0}),e.addEventListener("mousedown",h),window.addEventListener("mousemove",E),window.addEventListener("mouseup",T)}function O(e){return e.touches&&e.touches[0]?e.touches[0].clientX:e.clientX??0}function me(e){return e.touches&&e.touches[0]?e.touches[0].clientY:e.clientY??0}function J(e,t){const o=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(o*o+s*s)}function he(){const e={angle:0,rotateBy(t){e.angle+=t*.004}};return e}function pe(e){const t={spot:{x:e.clientWidth*.5,y:e.clientHeight*.55,r:0,a:0},lastTapAt:0,tapSpot(o,s,i,n){i==="low"&&n==="light"&&te("hand","light")&&(t.spot.x=o,t.spot.y=s,t.spot.r=110,t.spot.a=.22,t.lastTapAt=performance.now())},update(o,s){o-t.lastTapAt>1200&&(t.spot.a*=.92,t.spot.r*=.985);const n=Math.min(.06,s/4e4*.06);t._idleGlow=n},draw(o,s,i){if(t._idleGlow>0&&(o.fillStyle=`rgba(255,255,255,${t._idleGlow})`,o.fillRect(0,0,s,i)),t.spot.a<.01)return;const n=o.createRadialGradient(t.spot.x,t.spot.y,0,t.spot.x,t.spot.y,t.spot.r);n.addColorStop(0,`rgba(255,255,255,${t.spot.a})`),n.addColorStop(1,"rgba(255,255,255,0)"),o.fillStyle=n,o.fillRect(0,0,s,i)}};return t}function ge(){const e=t=>{navigator.vibrate&&navigator.vibrate(t)};return{step(t){t==="low"?e(6):t==="normal"?e(10):t==="high"&&e(16)},touch(t){t==="low"?e(4):t==="normal"?e(8):t==="high"&&e(12)}}}const w=(()=>{let e=null,t=null,o=!1,s="spatial",i=null;function n(c="spatial"){if(o){r(c);return}e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain(),t.gain.value=.65,t.connect(e.destination),i=e.createPanner(),i.panningModel="HRTF",i.distanceModel="inverse",i.refDistance=1,i.maxDistance=12,i.rolloffFactor=1.1,i.coneInnerAngle=360,i.coneOuterAngle=0,i.coneOuterGain=0,r(c),o=!0}function r(c){s=c,t&&(s==="none"?t.gain.value=0:t.gain.value=.65)}function g(){return e?e.currentTime:0}function f(){const c=2*((e==null?void 0:e.sampleRate)||48e3),m=e.createBuffer(1,c,e.sampleRate),b=m.getChannelData(0);for(let y=0;y<c;y++)b[y]=(Math.random()*2-1)*.25;const a=e.createBufferSource();return a.buffer=m,a.loop=!0,a}function l(c=180){const m=e.createOscillator();return m.type="sine",m.frequency.value=c,m}function u(c,m,b,a){if(e)if(s==="mono")c.connect(t);else{const y=e.createGain();y.gain.value=1,c.connect(y);const h=e.createPanner();return h.panningModel="HRTF",h.distanceModel="inverse",h.refDistance=1,h.maxDistance=12,h.rolloffFactor=1.1,h.positionX.value=m,h.positionY.value=b,h.positionZ.value=a,y.connect(h),h.connect(t),{gain:y,panner:h}}}function d(c){if(!e)return;const m=Math.sin(c),b=-Math.cos(c),a=e.listener;a.forwardX?(a.forwardX.value=m,a.forwardY.value=0,a.forwardZ.value=b,a.upX.value=0,a.upY.value=1,a.upZ.value=0):a.setOrientation(m,0,b,0,1,0)}return{ensureStarted:n,setMode:r,now:g,createNoise:f,createSine:l,connectSpatial:u,setListenerAngle:d,get ac(){return e},get started(){return o},get mode(){return s},get master(){return t}}})(),S=(()=>{let e=null,t=null,o=null,s=null;function i(){w.ac&&(n(),e=w.createNoise(),t=w.ac.createGain(),t.gain.value=0,e.connect(t),t.connect(w.master),e.start(),o=w.createSine(145),s=w.ac.createGain(),s.gain.value=0,o.connect(s),s.connect(w.master),o.start())}function n(){try{e==null||e.stop()}catch{}try{o==null||o.stop()}catch{}e=null,t=null,o=null,s=null}function r(f){t&&t.gain.setTargetAtTime(f,w.now(),.08)}function g(f,l=null){s&&(l&&o&&o.frequency.setTargetAtTime(l,w.now(),.08),s.gain.setTargetAtTime(f,w.now(),.08))}return{boot:i,stop:n,setAmbience:r,setTone:g}})(),A=(()=>{let e=!1,t=!1,o=0,s=0;function i(){w.started&&(S.boot(),e=!0)}function n(){e&&(S.setAmbience(.015),S.setTone(0))}function r(a,y,h){if(!e)return;w.setMode(h),w.setListenerAngle(y);const E=Math.min(1,a/12e3),T=.02+E*.08;S.setAmbience(T);const v=(Math.sin(performance.now()/1e3*.6)+1)*.5,M=E*.035*(v>.92?1:0);if(S.setTone(M,150+Math.sin(performance.now()/1500)*8),t){const x=(Math.sin(performance.now()/140)+1)*.5;S.setTone(Math.max(M,.01+x*.01),140)}o*=.96}function g(a,y){if(!e)return;const h=w.ac;if(!h)return;const E=w.createNoise(),T=h.createGain(),v=h.currentTime,M=m(y);T.gain.setValueAtTime(0,v),T.gain.linearRampToValueAtTime(M,v+.01),T.gain.exponentialRampToValueAtTime(1e-4,v+.12),E.connect(T);const x=Math.sin((s+=.6)+o)*.6,I=-.8-(a<0?.15:0);w.connectSpatial(T,x,0,I),E.start(),setTimeout(()=>{try{E.stop()}catch{}},140),a<0&&S.setAmbience(.07)}function f(a){if(!e)return;const y=w.ac;if(!y)return;const h=w.createNoise(),E=y.createGain(),T=y.currentTime,v=b(a);E.gain.setValueAtTime(0,T),E.gain.linearRampToValueAtTime(v,T+.008),E.gain.exponentialRampToValueAtTime(1e-4,T+.06),h.connect(E),w.connectSpatial(E,.2,0,-.7),h.start(),setTimeout(()=>{try{h.stop()}catch{}},80)}function l(a){o+=a*.002,o=Math.max(-2,Math.min(2,o))}function u(){t=!0}function d(){t=!1}function c(a){e&&a==="low"&&S.setAmbience(.01)}function m(a){switch(a){case"heel":return .08;case"leather":return .06;case"shoes":return .045;case"zori":return .05;default:return .028}}function b(a){switch(a){case"glove":return .045;case"stick":return .06;case"light":return .03;default:return .03}}return{boot:i,update:r,step:g,touch:f,pinch:l,holdStart:u,holdEnd:d,onUserAction:n,lightTap:c}})();let G=null,L=null;function ve(){L=document.getElementById("senseCanvas"),G=L.getContext("2d",{alpha:!1});const e=()=>{const n=Math.min(2,window.devicePixelRatio||1);L.width=Math.floor(L.clientWidth*n),L.height=Math.floor(L.clientHeight*n),G.setTransform(n,0,0,n,0,0)};e(),window.addEventListener("resize",e,{passive:!0});const t=he(),o=pe(L),s=ge();fe({canvas:L,onAnyInput:()=>{ne(),A.onUserAction()},onRoam:n=>t.rotateBy(n),onStep:n=>{A.step(n,p.settings.foot),s.step(p.settings.pulse)},onHoldWalk:n=>{n?A.holdStart():A.holdEnd()},onTouch:()=>{A.touch(p.settings.hand),s.touch(p.settings.pulse)},onPinch:n=>{A.pinch(n)},onTapSpot:(n,r)=>{o.tapSpot(n,r,p.settings.light,p.settings.hand),A.lightTap(p.settings.light)}}),window.addEventListener("sense-unlock-audio",()=>{w.ensureStarted(p.settings.sound),A.boot()});const i=n=>{const r=oe(n);A.update(r,t.angle,p.settings.sound),o.update(n,r),we(G,L.clientWidth,L.clientHeight,r,t.angle,o),requestAnimationFrame(i)};requestAnimationFrame(i)}function we(e,t,o,s,i,n){const r=e.createRadialGradient(t*.5,o*.55,0,t*.5,o*.55,Math.max(t,o)*.7);r.addColorStop(0,"rgb(5,5,5)"),r.addColorStop(1,"rgb(0,0,0)"),e.fillStyle=r,e.fillRect(0,0,t,o);const g=.02+Math.min(.05,s/25e3*.05);e.fillStyle=`rgba(255,255,255,${g})`;for(let f=0;f<18;f++){const l=(Math.sin((i+f)*1.7)*.5+.5)*t,u=(Math.cos((i*.7+f)*1.3)*.5+.5)*o;e.fillRect(l,u,1,1)}n.draw(e,t,o)}function U(){const e=document.getElementById("billingOverlay");e.hidden=!0}function ye(){const e=document.getElementById("billingOverlay");document.getElementById("billingCancel").addEventListener("click",()=>U()),e.addEventListener("pointerdown",o=>{o.target.closest(".billing-panel")||U()})}function be(){W(),ae({dockEl:document.getElementById("legalDock")}),ce({gearEl:document.getElementById("gearBtn")}),K(),de(),ye(),ve(),document.getElementById("gearBtn").addEventListener("click",()=>{ue()});const e=()=>{document.removeEventListener("pointerdown",e,!0),document.removeEventListener("touchstart",e,!0),window.dispatchEvent(new Event("sense-unlock-audio"))};document.addEventListener("pointerdown",e,!0),document.addEventListener("touchstart",e,!0)}be();
